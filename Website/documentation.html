<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->  
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->  
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->  
<head>
    <title>Smarty-Light, votre lumière intelligente</title>
    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">    
    <!-- Favicon includes -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="assets/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="assets/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="assets/favicon/manifest.json">
    <link rel="mask-icon" href="assets/favicon/safari-pinned-tab.svg" color="#f7f229">
    <link rel="shortcut icon" href="assets/favicon/favicon.ico">
    <meta name="msapplication-config" content="assets/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- End of Favicon includes -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <!-- Global CSS -->
    <link rel="stylesheet" href="assets/plugins/bootstrap/css/bootstrap.min.css">   
    <!-- Plugins CSS -->    
    <link rel="stylesheet" href="assets/plugins/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="assets/plugins/prism/prism.css">
    <link rel="stylesheet" href="assets/plugins/elegant_font/css/style.css">
    
    <!-- Theme CSS -->
    <link id="theme-style" rel="stylesheet" href="assets/css/styles.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
</head> 

<body class="body-green">
    <div class="page-wrapper">
        <!-- ******Header****** -->
        <header id="header" class="header">
            <div class="container">
                <div class="branding">
                    <h1 class="logo">
                        <a href="index.html">
                            <span aria-hidden="true" class="fa fa-lightbulb-o icon"></span>
                            <span class="text-highlight">Smarty</span><span class="text-bold">Light</span>
                        </a>
                    </h1>
                </div><!--//branding-->
                <ol class="breadcrumb">
                    <li><a href="index.html">Accueil</a></li>
                    <li class="active">Documentation</li>
                </ol>
            </div><!--//container-->
        </header><!--//header-->
        <div class="doc-wrapper">
            <div class="container">
                <div id="doc-header" class="doc-header text-center">
                    <h1 class="doc-title"><i class="icon fa fa-paper-plane"></i>Documentation</h1>
                    <div class="meta"><i class="fa fa-clock-o"></i> Derni&egrave;re modification: 16 mai 2017</div>
                </div><!--//doc-header-->
                <div class="doc-body">
                    <div class="doc-content">
                        <div class="content-inner">
						<p>Vous retrouverez sur cette page les r&eacute;sultats de nos recherches; celles-ci nous ont permis de mettre à terme le projet</p>
                            <section id="electricite" class="doc-section">
                                <h2 class="section-title">&Eacute;lectricit&eacute;</h2>
								<p>La fabrication du circuit &eacute;lectrique de notre ampoule à DEL requiert plusieurs composants &eacute;lectroniques pour être fonctionnel.<br>
									Dans cette section, nous allons passer en revue chacun de ces composants, afin d'en comprendre le fonctionnement.<br><br>
									Puisque nous avons choisi d'utiliser une diode &eacute;lectroluminescente (DEL) comme source de lumière, nous allons commencer par d&eacute;finir ce qu'est une <strong>diode</strong>. 
								</p>	
								<div id="diodes"  class="section-block">
                                    <h3 class="block-title">Les Diodes</h3>
										<p>Une diode est l'un des composants &eacute;lectroniques que l'on retrouve dans la quasi-totalit&eacute; des appareils &eacute;lectroniques que nous utilisons tous les jours.<br><br>
										Le rôle d'une diode dans un circuit &eacute;lectrique est bien simple: il consiste à <u>laisser passer le courant &eacute;lectrique dans une direction, et de le bloquer dans l'autre</u>.
										On comprend donc pourquoi le sens de branchement d'une diode a une importance.<br><br>
										<figure><img class="img-responsive" src="assets/images/Diode_symbol.png" alt="Symbole de la diode" />
										<figcaption>Symbole de la diode dans un circuit &eacute;lectrique. Le sens de la flèche d&eacute;montre le sens dans lequel le courant peut passer.</figcaption>
										</figure>
										<br><br>
										Maintenant que nous connaissons le rôle de la diode, attardons-nous à sa composition. <br><br>
										Une diode est compos&eacute; de deux <strong>semi-conducteurs</strong>. Un semi-conducteur est un mat&eacute;riau qui est normalement isolant, mais qui a tout de même une faible probabilit&eacute; de laisser passer les &eacute;lectrons, c'est-à-dire de conduire le courant.
										On dit qu'un semi-conducteur est <strong>intrinsèque</strong> lorsqu'il est pur, c'est-à-dire que sa conductivit&eacute; ne d&eacute;pend seulement que de sa structure mol&eacute;culaire. En r&eacute;alit&eacute;, un semi-conducteur n'est jamais complètement pure, mais il existe des substances comme le silicium qui s'y approchent fortement.<br><br>
										
										Afin de pouvoir manipuler les caract&eacute;ristiques &eacute;lectriques d'un semi-conducteur, on a recourt au principe de <strong>dopage</strong>. Ce principe consiste en fait à "contaminer" le semi-conducteur intrinsèque avec des atomes poss&eacute;dant un nombre diff&eacute;rent d'&eacute;lectrons de valence. En se faisant, il est possible d'obtenir soit un ajout ou un manque d'&eacute;lectrons libres dans la substance.<br><br> 
										Attardons-nous sur le cas du silicium, qui est l'&eacute;l&eacute;ment utilis&eacute; dans la plupart des diodes et des transistors.<br><br>
										
										<figure><img class="img-responsive" src="assets/images/silicium_pure.png" alt="Silicium pur" />
										<figcaption>Structure du silicium à l'&eacute;tat pur</figcaption>
										</figure>
										Dans un bloc de silicium pur, tous les &eacute;lectrons de valences seront li&eacute;s entre-eux par des liaisons covalentes. Il n'y a donc aucun &eacute;lectron <i>libre</i>, ce qui signifie que le courant ne peut pas passer. 
										
										<br><br>Afin d'obtenir des &eacute;lectrons libres dans le silicium pur, une faible quantit&eacute; d'un &eacute;l&eacute;ment ayant un nombre plus &eacute;lev&eacute; d'&eacute;lectrons de valence y sera inject&eacute;e. On parle alors de <strong>dopage</strong>. 
										
                                        </p>
										<p>
                                        <figure>
                                            <img class="img-responsive" src="assets/images/silicium_n-type.png" alt="Silicium dop&eacute; avec du phosphore" />
										    <figcaption>Silicium dop&eacute; à l'aide du phosphore - Dopage de type-N</figcaption>
										</figure>
										
										<br>
										Puisque le phosphore possède 5 &eacute;lectrons de valence et que le silicium n'en possède que 4, il y aura forc&eacute;ment un &eacute;lectron c&eacute;libataire. 
                                        Cet &eacute;lectron libre pourra facilement se d&eacute;placer dans la structure du silicium, ce qui permettra au courant de passer.
                                        On appelle ce type de dopage le "n-type", puisqu'on parle d'une charge n&eacute;gative qui se d&eacute;place.
										</p>
                                        <p>
                                        <figure>
                                            <img class="img-responsive" src="assets/images/silicium_p-type.png" alt="Silicium dop&eacute; avec du bore" />
										    <figcaption>Silicium dop&eacute; à l'aide du bore - Dopage de type-P</figcaption>
										</figure>
                                        &Agrave; l'inverse du phosphore, le bore poss&egrave;de un &eacute;lectron de moins que le silicium sur sa couche de valence. 
                                        Lors de l'injection du bore dans un bloc de silicium pur, il y aura un manque d'&eacute;lectron caus&eacute; par la structure atomique du bore, qui pourra &eacute;galement se d&eacute;placer.
                                        On parle alors de trous (<i>holes</i> en anglais) qui se d&eacute;placent dans le semi-conducteur. 
                                        Ce dopage est appelé "p-type", puisqu'on a maintenant un manque d'électron - un trou - qui se déplace; on en conclut donc que c'est une charge positive qui peut se déplacer.
                                        </p>
                                        <p>
                                            Comme mentionné précédemment, une diode est composée de deux semi-conducteurs: un semi-conducteur de type-p et un semi-conducteur de type-n, qui sont formés respectivement par l'ajout de substance comme le bore et le phosphore.
                                            Voici une représentation graphique d'une jonction p-n:
                                            <figure>
                                                <img class="img-responsive" src="assets/images/jonction-pn.png" alt="Silicium dop&eacute; avec du bore" />
										        <figcaption>Jonction P-N - Illustration de la structure d'une diode</figcaption>
										    </figure>
                                        </p>
                                        <p>
                                            À la jonction PN, un phénomène bien particulier se produit. Les électrons libres du semi-conducteur dopé de type-n seront naturellement attirés vers les trous (charges positives) du semi-conducteur de type P.
                                            Le côté gauche (type P) de la jonction sera donc légèrement négatif, tandis que le côté droit (type N) sera légèrement positif.
                                            Voici une illustration de ce phénomène:
                                            <figure>
                                                <img class="img-responsive" src="assets/images/jonction-pn-depletion.png" alt="Silicium dop&eacute; avec du bore" />
										        <figcaption>Jonction P-N - Illustration de la zone de déplétion</figcaption>
										    </figure>
                                            La zone influencée par l'attraction des électrons libres vers les trous du type-p au repos est nommée la <strong>zone de déplétion</strong>.
                                            Dans cette dernière, aucun électron libre n'est présent; le courant ne peut donc pas passer. Une <strong>barrière de potentiel</strong> d'environ 0.7V est créée,
                                            ce qui signifie qu'il faudra fournir un potentiel d'au moins 0.7V afin de franchir cette barrière et donc, permettre au courant de passer.
                                            Voyons ce qui se produit lorsque nous fournissons une source de courant externe aux bornes de la diode.
                                        </p>
										<p>
											<figure>
                                                <img class="img-responsive" src="assets/images/diode_reverse-biased.png" alt="Polarisation inverse d'une diode" />
										        <figcaption>Polarisation inverse d'une diode</figcaption>
										    </figure>
											Lorsque l'on relie le terminal positif d'une batterie du côté du semi-conducteur de type N, les électrons y sont attirés.
											La zone de déplétion et la barrière de potentiel à franchir s'élargissent grandement, ce qui signifie qu'il faudra beaucoup plus de potentiel afin de faire passer le courant.
											Résultat, le courant ne peut pas passer. On surnomme ce type de branchement un branchement à <strong>polarisation inverse</strong> d'une diode.
										</p>
                                        <p>
											<figure>
                                                <img class="img-responsive" src="assets/images/diode_forward-biased.gif" alt="Polarisation directe d'une diode" />
										        <figcaption>Polarisation directe d'une diode</figcaption>
										    </figure>
											Vous remarquerez que le phénomène est maintenant bien différent du cas précédent. Lorsque la borne négative d'une source de courant est reliée du côté des électrons libres (type N), ces derniers en sont repoussés. 
                                            Si la différence de potentiel aux bornes de la diode est suffisante pour franchir la barrière de potentiel (0.7V dans le cas de la diode au Silicium), les électrons libres la traverseront, se recombinant avec les <strong>trous</strong>.<br>
                                            <br>Lorsqu'un électron franchit la barrière de potentiel pour aller se recombiner, il passe de la bande de conduction à la bande de valence, baissant ainsi en niveau d'énergie.
										</p>
									
                                </div><!--//Diodes section-block-->
								<div id="del"  class="section-block">
                                    <h3 class="block-title">Les Diodes &Eacute;lectroluminescentes (DEL)</h3>
                                    <p>Mantenant que nous comprenons le fonctionnement d'une diode, il est très facile de comprendre les diodes électroluminescentes.
                                        Comme mentionné précédemment, la migration d'un électron de la partie N à la partie P ainsi que sa recombinaison avec un trou lui inflige une perte d'énergie.
                                        <br><br>Dans le cas de la diode électroluminescente, cette énergie se voit dégagée sous la forme d'un photon. Il est possible de facilement calculer la longueur d'onde du photon émis en fonction
                                        de la quantité d'énergie libérée. La formule suivante permet de le faire:<br>
                                        $$E=\frac{hc}{\lambda}$$<br>
                                        o&ugrave;</p>
                                        <p class="equation">          \(E=Énergie\) (en joules),<br>
                                                    \(h=6.626x10^{-34}J*s\) (Constante de Planck),<br>
                                                    \(c=3.00x10^8m/s\ \) (Vitesse de la lumière) et <br>
                                                    \(\lambda = Longueur\ d'onde\ du\ photon,\ en\ m\)
                                        
                                    </p>
									
                                </div><!--//DEL section-block-->
                                <div id="transistors" class="section-block">
                                    <h3>Les transistors (NPN)</h3>
                                    <p>Les transistors sont essentiels au bon fonctionnement de chaque appareil électronique. En effet, de nos jours, des milliards de transistors sont au coeur de tous les processeurs permettant l'utilisation des appareils.
                                        Par exemple, en date de publication de cet article (2017-04-21), le iphone 7 compte 3,3 milliards de transistors au coeur de son processeur A10 &agrave; quadruple coeurs, avec une taille aussi minime que 16 nm (1 nm = \(1x10^{-9}\)m). 
                                        Leur symbole sur un schéma électrique est le suivant:<br>
                                        <figure><img class="img-responsive" src="assets/images/NPN_transistor_symbol.png" alt="Symbole du transistor (NPN)" />
										<figcaption>Symbole du transistor dans un circuit &eacute;lectrique. Le sens de la flèche d&eacute;montre le sens dans lequel le courant peut passer.</figcaption>
										</figure>
                                    </p>
                                    <p>
                                        Les transistors ont deux fonctionnalitées principales. Ils peuvent agir comme:
                                        <ol>
                                            <li>Amplificateur de signaux électriques</li>
                                            <li>Interrupteur de signaux électriques (notamment dans les circuits logique)</li>
                                        </ol>
                                        Nous reviendrons sur ces fonctionnalitées dans un moment. Commencons par comprendre leur composition.
                                    </p>

                                    <p>Comme pour le cas des diodes, un transistor est con&ccedil;u &agrave; l'aide de jonctions p-n. Nous pouvons plus simplement l'expliquer comme étant la jonction de deux diodes, telles que vues précédemment:<br>
                                        
                                        
                                    </p>
                                </div><!--//Transistors section-block-->
								<div id="convertisseur-buck" class="section-block">
									<h3>Convertisseur buck (Alimentation &agrave; d&eacute;coupage)</h3>
									<p>Le hacheur en série plus communément appeler sous le nom de convertisseur Buck sert à réduire la tension fournie par le réseau électrique d’un bâtiment conventionnel afin d’alimenter les appareils électroniques dont elles requièrent une faible tension. Le convertisseur Buck comporte plusieurs avantages : </p>
									<ul>
										<li>Il possède un poids plume, si on le compare au transformateur conventionnel qui est composé d’une grande armature métallique et de grande bobine de fil qui est très massive. </li>
										<li>Le convertisseur buck est très compact, c’est pourquoi c’est la technologie première des chargeurs d’appareille mobile, ils ne sont pas encombrants et possèdent une grande mobilité.</li> 
										<li>Il possède un rendement typique élevé (75%) qui permet d’éviter un dégagement thermique imposant et une perte imposante d’énergie électrique.</li>
										<li>Le cout de production est aussi un avantage, car les composantes du circuit que le compose ne sont pas dispendieuse contrairement à un transformateur conventionnel qui possède une grande quantité de métaux précieux. </li>
									</ul> 
								    <p>
                                        <figure><img class="img-responsive" src="assets/images/convertisseur_buck.jpg" alt="Convertisseur buck" />
										<figcaption>Convertisseur buck<br><span class="source-text">Source: <a href="https://fr.wikipedia.org/wiki/Alimentation_à_découpage" alt="Wikipédia - Alimentation à découpage">Wikipédia</a></span></figcaption>
										</figure>
                                        Les éléments principaux d’un convertisseur buck sont les suivant :</p>
					                <ol> 
									<li>Connecteur d’alimentation (120v au Québec)</li>
                                    <figure><img class="img-responsive" src="assets/images/120_AC.png" alt="Alimentation 120v AC" />
										<figcaption>Alimentation 120v AC</figcaption>
										</figure>
									<li>Un fusible de protection qui assure une certaine limite au courant afin d’éviter des dommages au circuit.</li>
                                    <figure>
                                        <img class="img-responsive" src="assets/images/Fusible.png" alt="Fusible" />
										<figcaption>Fusible</figcaption>
									</figure>

                                    <li>Filtre EMI, et bobine d’arrêt pour bloquer les hautes fréquences, atténuer les basses fréquences et laisser passer le continu.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Inductance.png" alt="Inductance (bobine)" />
										<figcaption>Inductance (bobine)</figcaption>
									</figure>
                                    <li>Un pont de diode permet de convertir le courant AC (courant alternatif) en un courant DC (courant continu).</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Pont_diodes.jpg" alt="Pont de diodes (AC vers DC)" />
										<figcaption>Pont de diodes (AC vers DC)</figcaption>
									</figure>
                                    <li>Un condensateur de filtrage stocke l'énergie pour l'étage de découpage.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Condensateur_filtrage.png" alt="Condensateur" />
										<figcaption>Condensateur</figcaption>
									</figure>
                                    <li>Un transistor de découpage qui va permettre d’ouvrir (on) ou de fermer le circuit (off), il est monté sur un radiateur, car c’est une composante électrique qui dégage une importante quantité d’énergie thermique et le radiateur va lui permettre d’évacuer effectivement sa chaleur afin qu’il conserve une température de fonctionnement normal.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Transistor_decoupage.png" alt="Transistor" />
										<figcaption>Transistor</figcaption>
									</figure>
                                    <li>Un transformateur électrique qui va contribuer à l’abaissement de la tension et à l’isolation entre les parties de haute et de basse tension.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Transformateur.png" alt="Transformateur" />
										<figcaption>Transformateur</figcaption>
									</figure>
                                    <li>Une Diode Schottky (commutation rapide) montée sur un radiateur.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Diode_schottky.png" alt="Diode Schottky" />
										<figcaption>Diode Schottky</figcaption>
									</figure>
                                    <li>Condensateur de filtrage.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Condensateur_filtrage.png" alt="Condensateur" />
										<figcaption>Condensateur</figcaption>
									</figure>
                                    <li>Une bobine de filtrage.</li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Inductance.png" alt="Inductance (bobine)" />
										<figcaption>Inductance (bobine)</figcaption>
									</figure>
                                    <li>Circuit de commande de l'optocoupleur.</li>
                                    <li>Un optocoupleur permet une isolation entre les parties de haute et de basse tension et permet le signal entre deux composants sans qu’il y ait de contact entre eux (signal infrarouge d’une diode électroluminescent à un récepteur (le phototransistor). </li>
									<figure>
                                        <img class="img-responsive" src="assets/images/Octocoupleur.png" alt="Octocoupleur" />
										<figcaption>Octocoupleur</figcaption>
									</figure>
                                    <li>Circuit de commande du transistor de découpage. </li>
                                    <li>Sortie de l'alimentation. </li>
									</ol> 
									<p>Explication de la variation du courant de l’inductance L dans un circuit simplifier</p>
									<figure>
                                        <img class="img-responsive" src="assets/images/Schema_convertisseur_buck.png" alt="Schéma du convertisseur buck" />
										<figcaption>Schéma du convertisseur buck</figcaption>
									</figure>
                                    <figure>
                                        <img class="img-responsive" src="assets/images/Differents_etats_convertisseur_buck.png" alt="Différents états du convertisseur buck" />
										<figcaption>Différents états du convertisseur buck</figcaption>
									</figure>
                                    <p>Lorsque l’interrupteur est passant, on peut observer que le courant dans le convertisseur buck possède un taux d’accroissement, car l’énergie stockée dans l’inductance augmente.Lorsque l’interrupteur est bloqué, on peut observer que le courant dans le convertisseur buck possède un taux de décroissement, car l’énergie stockée dans l’inductance diminue.</p>
									<p>Sources : <a href="https://fr.wikipedia.org/wiki/Alimentation_%C3%A0_d%C3%A9coupage">Alimentation à découpage - Wikipédia</a>, 
                                                <a href="https://fr.wikipedia.org/wiki/Convertisseur_Buck">Convertisseur buck - Wikipédia</a></p>
								</div>
							</section><!--//doc-section-->
                            <section id="informatique" class="doc-section">
                                <h2 class="section-title">Informatique</h2>
								<p>Dans cette section, nous allons expliquer en détails le fonctionnement du code source des différentes parties du projet.
								<div id="micro-controleur" class="section-block">
                                    <h3 class="block-title">Programmation du micro-contrôleur (ESP8266)</h3>
									<p>Le code source du micro-contrôleur lui permet, une fois qu'il s'est connecté au réseau WiFi, de se connecter au serveur 
                                        via un socket web (utilisation de la librairie SocketIO) et d'assigner les données qu'il y reçoit (valeurs Rouges, Vertes et Bleues)
                                         aux pins responsables de contrôler le rouge, le vert et le bleu.
                                    </p>
                                    <h4>Fonction Setup()</h4>
                                    <p>Commencons par jeter un coup d'oeil à la fonction Setup() qui est appelée au démarrage:</p>
                                    <pre class="language-cpp"><code class="language-cpp">void setup() {
    USE_SERIAL.begin(115200);
    USE_SERIAL.setDebugOutput(true);
    USE_SERIAL.println();
    USE_SERIAL.println();
    USE_SERIAL.println();
      for(uint8_t t = 4; t > 0; t--) {
          USE_SERIAL.printf("[SETUP] BOOT WAIT %d...\n", t);
          USE_SERIAL.flush();
          delay(1000);

      }
    WiFiMulti.addAP(ssid, password);
    while(WiFiMulti.run() != WL_CONNECTED) {
        delay(100);
    }
    webSocket.on("Data", event);

    //On se connect au webSocket
    webSocket.begin(host, port);

    //Initialisation des pins pour la LED
    pinMode(redPin, OUTPUT);
    pinMode(greenPin, OUTPUT);
    pinMode(bluePin, OUTPUT);
}</code></pre>
                                <p>La première partie importante est l'ajout du point d'accès réseau pour s'y connecter. 
                                    La fonction addAP(ssid,password) qui est fournie dans la librairie ESP8266WiFiMulti permet de se connecter au réseau WiFi:</p>
                                    <pre class="language-cpp"><code class="language-cpp">WiFiMulti.addAP(ssid, password);</code></pre>
                                <p>La boucle qui suit permet de s'assurer que l'on soit connecté au réseau. Si on ne l'est pas, on ajoute un délai au temps de démarrage et on attend d'y être connecté:</p>
                                <pre class="language-cpp"><code class="language-cpp">while(WiFiMulti.run() != WL_CONNECTED) {
    delay(100);
}</code></pre>
                                <p>Ensuite, l'instance de la classe SocketIoClient définie globalement nous permet d'assigner une fonction "event" lorsque le socket reçoit l'événement "Data":</p>
                                <pre class="language-cpp"><code class="language-cpp">webSocket.on("Data", event);</code></pre>
                                <p>On peut alors se connecter au websocket à l'adresse du serveur avec la fonction suivante:</p>
                                <pre class="language-cpp"><code class="language-cpp">webSocket.begin(host, port);</code></pre>
                                <p>Les dernières lignes de code de la fonction Setup() servent à initialiser les pins des différentes DELs en mode output:</p>
                                <pre class="language-cpp"><code class="language-cpp">pinMode(redPin, OUTPUT);
pinMode(greenPin, OUTPUT);
pinMode(bluePin, OUTPUT);</code></pre>
                                <h4>Fonction qui gère l'événement reçut pas le socket - event(const char * payload, size_t length)</h4>
                                <p>Maintenant, attardons-nous à la fonction qui gère l'événement reçus par le socket:</p>
                                <pre class="language-cpp"><code class="language-cpp">void event(const char * payload, size_t length) {
  String string(payload);
  int commaIndex = string.indexOf(',');
  //  On cherche la prochaine virgule après la première
  int secondCommaIndex = string.indexOf(',', commaIndex + 1);

  redValue = string.substring(0, commaIndex).toInt();
  greenValue = string.substring(commaIndex+1, secondCommaIndex).toInt();
  blueValue = string.substring(secondCommaIndex+1).toInt();
  USE_SERIAL.printf("got message: %s\n", payload);
  USE_SERIAL.printf("red =  %d\n", redValue);
  USE_SERIAL.printf("green =  %d\n", greenValue);
  USE_SERIAL.printf("blue =  %d\n", blueValue);
}</code></pre>
                                <p>La définition de fonction est la manière dont un événement doit être redéfinit, selon la documentation de SocketIO. 
                                    Un string est instancié avec le contenu du payload ( <code class="language-cpp">String string(payload);</code> ), pour pouvoir utiliser les fonctions qui sont natives à la librairie String.
                                    Les données reçues ont la forme suivante: "Rouge,Vert,Bleu". Par exemple, si on recevait les données suivantes par le socket: "100,20,300", 
                                    nous devons être en mesure de récupérer les 3 nombres dans les variables différentes "redValue", "greenValue" et "blueValue".
                                    Pour se faire, nous allons récupérer les index des virgules dans la variable string:</p>
                                    <pre class="language-cpp"><code class="language-cpp">int commaIndex = string.indexOf(',');
//  On cherche la prochaine virgule après la première
int secondCommaIndex = string.indexOf(',', commaIndex + 1);</code></pre>
                                <p>Maintenant que nous connaissons les numéros d'indice des virgules, nous pouvons utiliser la fonction <strong>substring</strong> pour récupérer les valeurs dans les trois variables distinctes:</p>
                                <pre class="language-cpp"><code class="language-cpp">redValue = string.substring(0, commaIndex).toInt();
greenValue = string.substring(commaIndex+1, secondCommaIndex).toInt();
blueValue = string.substring(secondCommaIndex+1).toInt();</code></pre>
                                <p>Les dernières lignes de la fonction sont seulement des témoins dans le port série, utiles pour le déboguage.</p>
                                </div><!--//section-block-->
                                <div id="api" class="section-block">
                                    <h3 class="block-title">Serveur - Interface de programmation d'application (API)</h3>
                                    <p>Le serveur effectue le lien entre l'application web qui permet de contrôler les ampoules, ainsi que les ampoules mêmes.</p>
                                    <p>Nous allons réviser en détails les parties importantes. Commençons par le fichier Server.js. Les lignes suivantes ne servent qu'à authentifier et gérer les en-têtes de requêtes:</p>
                                    <pre class="language-javascript"><code class="language-javascript">app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(cors({origin: null}));

app.use((req, res, next) => {
            // Set permissive CORS header - this allows this server to be used only as
            // an API server in conjunction with something like webpack-dev-server.
            res.setHeader('Access-Control-Allow-Origin', '*');
            res.setHeader('Access-Control-Allow-Methods', 'POST, PUT, DELETE, GET');
            res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With');

            // Disable caching so we'll always get the latest comments.
            res.setHeader('Cache-Control', 'no-cache');
            next();
});</code></pre>                
                                <p>Pour en apprendre plus sur les contrôles d'accès HTTP et CORS, vous pouvez <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank">visiter cette page</a>.</p>
                                <p>La ligne suivante permet d'inclure le fichier de définition des routes, ainsi que de déclarer les variables globales :</p>
                                <pre class="language-javascript"><code class="language-javascript">require('./routes/routes-config')(app);
var allSockets = [];
app.lightbulbs = [];
var uniqueID = 0;</code></pre>
                                <p>Nous reviendrons sur les routes plus en détails par la suite. Attaquons maintenant le gros morceau, qui est ce qui se produit lorsqu'un socket se connecte:</p>
                                <pre class="language-javascript"><code class="language-javascript">app.io.on('connection', function (socket){
console.log('connection', socket.id);
allSockets.push(socket); //On ajoute l'ampoule qui se connecte à la liste

// On assigne un ID à l'ampoule qui vient de se connecter

var lightbulbID = generateID();   //On lui donne un id
console.log('Ajout de l\'ampoule avec l\'ID:', socket.id);

// On récupère l'adresse ip
var clientIp = socket.request.connection.remoteAddress;
var clientPort = socket.request.connection.remotePort;

// On extrait les caractères ::ffff: ipv6 pour récupérer seulement ipv4
var idx = clientIp.lastIndexOf(':');
if (~idx && ~clientIp.indexOf('.'))
{
    clientIp = clientIp.slice(idx + 1);
}
console.log('Nouvelle connexion depuis ' + clientIp + ":" + clientPort);
app.lightbulbs.push({id: lightbulbID,
        socketID: socket.id,
        red: 0,
        green: 0,
        blue: 0,
        ip: clientIp,
        port: clientPort
                
});

// Event handler de déconnexion
socket.on('disconnect', function(){
    console.log('Socket avec le ID #', socket.id, ' déconnecté');
    var i = allSockets.indexOf(socket);
    allSockets.splice(i, 1);

    var indexLightbulbs = findWithAttr(app.lightbulbs,'id',socket.id);
    app.lightbulbs.splice(indexLightbulbs,1);
})
});</code></pre>
                                <p>Le tableau "allSockets" contient tous les sockets. On y ajoute donc chaque socket qui se connecte:</p>
                                <pre class="language-javascript"><code class="language-javascript">allSockets.push(socket); //On ajoute l'ampoule qui se connecte à la liste</code></pre>
                                <p>On définit ensuite un ID unique à l'aide de la fonction generateID():</p>
                                <pre class="language-javascript"><code class="language-javascript">var lightbulbID = generateID();   //On lui donne un id</code></pre>
                                <p>Cette fonction incrémente de 1 un compteur et en retourne la valeur, afin de toujours avoir un identifiant unique.</p>
                                <pre class="language-javascript"><code class="language-javascript">function generateID(){
  return uniqueID++;
}</code></pre>
                                <p>On récupère ensuite les informations de connexion du socket, notamment son adresse IP et le port de connexion:</p>
                                <pre class="language-javascript"><code class="language-javascript">var clientIp = socket.request.connection.remoteAddress;
var clientPort = socket.request.connection.remotePort;
</code></pre>
                                <p>Étant donné que l'adresse ip retournée par la connexion socket est en format ipv6 ("::ffff:192.168.2.1", on y retire les caractères suivant les deux points ':' :</p>
                                <pre class="language-javascript"><code class="language-javascript">var idx = clientIp.lastIndexOf(':');
if (~idx && ~clientIp.indexOf('.'))
{
    clientIp = clientIp.slice(idx + 1);
}</code></pre>
                                <p>On recueille les informations de chaque ampoule (socket) dans un tableau, la variable "app.lightbulbs". On y ajoute donc l'ampoule qui vient d'être connectée :</p>
                                <pre class="language-javascript"><code class="language-javascript">app.lightbulbs.push({id: lightbulbID,
        socketID: socket.id,
        red: 0,
        green: 0,
        blue: 0,
        ip: clientIp,
        port: clientPort
                
});</code></pre>
                                <p>La dernière fonction qui est présente dans ce bloc est l'événement de déconnexion. 
                                    Il s'assure qu'on retire l'ampoule et le socket des tableaux allSockets et app.lightbulbs :</p>
                                    <pre class="language-javascript"><code class="language-javascript">socket.on('disconnect', function(){
    console.log('Socket avec le ID #', socket.id, ' déconnecté');
    var i = allSockets.indexOf(socket);
    allSockets.splice(i, 1);

    var indexLightbulbs = findWithAttr(app.lightbulbs,'id',socket.id);
    app.lightbulbs.splice(indexLightbulbs,1);
  });</code></pre>
                                <p>Vous remarquerez l'utilisation de la fonction finWithAttr(tableau, attribut, valeur). 
                                    Cette dernière vérifie si un élément du tableau contient l'attribut avec la valeur passée en argument.
                                    Si l'objet a bien la valeur à cet attribut, la fonction renvoie son indice au tableau. Sinon, elle renvoie -1. 
                                    Voici le code de cette fonction, qui se trouve dans le fichier "misc_functions.js" du sous-dossier "functions":</p>
                                <pre class="language-javascript"><code class="language-javascript">function findWithAttr(array, attr, value) {
    for(var i = 0; i < array.length; i ++) {
        value = parseInt(value, 10);
        if(array[i][attr] === value) {
            return i;
        }
    }
    return -1;
}

module.exports.findWithAttr = findWithAttr;</code></pre>
                                <p>La dernière partie du fichier Server.js permet d'initialiser l'écoute du serveur sur le port 3000, 
                                    permettant ainsi de recevoir des requêtes HTTP qui seront configurées dans le fichier routes-config.js :</p>
                                <pre class="language-javascript"><code class="language-javascript">http.listen(3000, function () {
  console.log('À l\'écoute sur le port *:3000');
});</code></pre>
                                <p>Revenons maintenant au fichier routes-config.js qui était appelée par l'application au début du fichier Server.js : </p>
                                <pre class="language-javascript"><code class="language-javascript">var lightsRouter    = require('./lights');

function routesConfig(app){
    app.use('/lights', lightsRouter);
}

module.exports=routesConfig;</code></pre>
                                <p>Cette fonction permet de définir la route "/lights" avec la variable lightsRouter. 
                                    Cela signifie que les requêtes http envoyées à l'adresse /lights sont définies par le fichier "lights.js" qui se trouve dans le dossier "routes".</p>
                                <p>Jettons un oeil au fichier "lights.js" :</p>
                                <pre class="language-javascript"><code class="language-javascript">var express     = require('express');
var router      = express.Router();
var findWithAttr  = require('../functions/misc_functions').findWithAttr;
const util = require('util');

router.post('/',function(req,res){
    console.log("Requête POST reçu");
    console.log(req.body);
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'POST, PUT, DELETE, GET');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With');
    var red = req.body.red;
    var green = req.body.green;
    var blue = req.body.blue; 
    if(req.body.id!=null)
    {
        
        console.log(req.app.lightbulbs);
        var id = req.body.id;
        if(req.app.lightbulbs)
        {
            var indexLightbulbs = findWithAttr(req.app.lightbulbs,'id',id);
            if(indexLightbulbs>=0)
            {
                var socketID = req.app.lightbulbs[indexLightbulbs].socketID;
                req.app.io.sockets.connected[socketID].emit('Data', red, green, blue);
                req.app.lightbulbs[indexLightbulbs].red = red;
                req.app.lightbulbs[indexLightbulbs].green = green;
                req.app.lightbulbs[indexLightbulbs].blue = blue;
                res.send("Succès!");
            }
            else
            {
                res.send("Il n'y a aucune ampoule avec l'ID #" + id);
            }
        }
    }
    else
    {
        //On modifie toutes les ampoules
        console.log("Requête -- Rouge:" + red + " Vert:" + green + " Bleu:" + blue);
        if((red >=0 && red <=1024) && (green >=0 && green <=1024) && (blue >=0 && blue <=1024))
        {
            req.app.io.sockets.emit('Data', red, green, blue);
            req.app.lightbulbs.forEach(function(element) {
                element.red = red;
                element.green = green;
                element.blue = blue;
            }, this);
            res.send("Succès!");
        }
        else
        {
            res.send("Veuillez entrer des valeurs entre 0 et 1024 pour les attributs 'red', 'green' et 'blue'.");
        }
    }
});

router.get('/',function(req,res){
    //On ajoute les header de response pour permettre
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "X-Requested-With, Content-Type");
    res.send(req.app.lightbulbs);
    /*console.log('Requête Get reçu...');
    console.log(req.app.lightbulbs);*/
});

//Route pour trouver acquérir l'information d'une ampoule unique
router.get('/unique/:id',function(req,res){
    
    res.header("Access-Control-Allow-Origin", "*");
    res.header("Access-Control-Allow-Headers", "X-Requested-With, Content-Type");
    if(req.params.id!=null)
    {
    var id = req.params.id;
        if(req.app.lightbulbs)
        {
            var tempLightbulbs = req.app.lightbulbs;
            var indexLightbulbs = findWithAttr(tempLightbulbs,'id',id);
            if(indexLightbulbs>=0)
            {
                // On renvoie l'ampoule unique trouvée;
                res.send(req.app.lightbulbs[indexLightbulbs]);
            }
            else
            {
                res.send(null);
                console.log("Index de lightbulb = ", indexLightbulbs);
                console.log(util.inspect(req.app.lightbulbs[indexLightbulbs], false, null))
            }
        }
        else{
            console.log("Erreur..");
        }
    }
    else
    {
        res.send("ID nul");
    }
});

module.exports=router;</code></pre>
                                <p>Vous remarquerez que le fichier est séparé en 3 fonctions distinctes : 
                                    <ol>
                                        <li><pre class="language-javascript"><code class="language-javascript">router.post('/',function(req,res){});</code></pre>
                                            <p>Cette fonction définie ce qui se produit lorsque le serveur reçoit une requête POST à l'url '/' de '/lights', donc à l'adresse 'localhost:3000/lights/'.
                                                La requête post doit contenir un corps JSON avec les variables body.red, body.green et body.blue. 
                                                Optionnellement, le corps peut contenir la variable body.id. Si la requête contient la variable body.id, les valeurs des variables assignées aux trois couleurs seront envoyées seulement à l'ampoule avec cet identifiant unique (ID).
                                                Sinon, les valeurs des trois couleurs seront envoyées à tous les sockets, c'est-à-dire qu'ils changeront la couleur et l'intensité de chaque ampoule.
                                            </p>
                                        </li>
                                        <li><pre class="language-javascript"><code class="language-javascript">router.get('/',function(req,res){});</code></pre></li>
                                        <p>Cette fonction est assez simple. Lorsqu'une requête GET est reçue à la route '/lights/', le serveur renvoie le tableau app.lightbulbs, qui contient les informations sur toutes les ampoules.</p>
                                        <li><pre class="language-javascript"><code class="language-javascript">router.get('/unique/:id',function(req,res){});</code></pre></li>
                                        <p>Cette fonction contient une route avec paramètre variable. La notation :id représente un paramètre de requête variable. 
                                            Elle prend place à l'adresse '/unique/:id', qui est relative à la route de base '/lights'. L'adresse complète de cette route est donc 'localhost:3000/lights/unique/:id', o&ugrave; id est un nombre variable.</p>

                                    </ol>
                                </p>
                                </div><!--//section-block-->
</section><!--//doc-section-->
                            
                        </div><!--//content-inner-->
                    </div><!--//doc-content-->
                    <div class="doc-sidebar hidden-xs">
                        <nav id="doc-nav">
                            <ul id="doc-menu" class="nav doc-menu" data-spy="affix">
                                <li><a class="scrollto" href="#electricite">&Eacute;lectricit&eacute;</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#diodes">Diodes</a></li>
                                        <li><a class="scrollto" href="#del">DELs</a></li>
                                        <li><a class="scrollto" href="#transistors">Transistors</a></li>
                                        <li><a class="scrollto" href="#convertisseur-buck">Convertisseur buck</a></li>
                                    </ul><!--//nav-->
								</li>
                                <li><a class="scrollto" href="#informatique">Informatique</a>
                                    <ul class="nav doc-sub-menu">
                                        <li><a class="scrollto" href="#micro-controleur">Micro-contrôleur (ESP8266)</a></li>
                                        <li><a class="scrollto" href="#api">Serveur (API)</a></li>
                                    </ul><!--//nav-->
								</li>
                            </ul><!--//doc-menu-->
                        </nav>
                    </div><!--//doc-sidebar-->
                </div><!--//doc-body-->              
            </div><!--//container-->
        </div><!--//doc-wrapper-->
        
    </div><!--//page-wrapper-->
    
    <footer id="footer" class="footer text-center">
        <div class="container">
            <!--/* This template is released under the Creative Commons Attribution 3.0 License. Please keep the attribution link below when using for your own project. Thank you for your support. :) If you'd like to use the template without the attribution, you can check out other license options via our website: themes.3rdwavemedia.com */-->
            <small class="copyright">Designed with <i class="fa fa-heart"></i> by <a href="http://themes.3rdwavemedia.com/" targe="_blank">Xiaoying Riley</a> for developers</small>
            
        </div><!--//container-->
    </footer><!--//footer-->
    
     
    <!-- Main Javascript -->          
    <script type="text/javascript" src="assets/plugins/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/plugins/prism/prism.js"></script>    
    <script type="text/javascript" src="assets/plugins/jquery-scrollTo/jquery.scrollTo.min.js"></script>                                                                
    <script type="text/javascript" src="assets/plugins/jquery-match-height/jquery.matchHeight-min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
    <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    
</body>
</html> 

